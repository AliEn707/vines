---
layout: site
title: Vines - XMPP/Jabber chat server for Ruby
---
<div id="nav" class="grid_3">
  <h1>vines></h1>
</div>
<div id="content" class="grid_6">
  <p id="intro">
    Vines is an XMPP chat server designed for easy install, configuration,
    and maintenance. Written in Ruby with EventMachine, Vines can handle any
    traffic you throw at it without breaking a sweat.
  </p>

  <h2>Install</h2>
<pre>
$ gem install vines
$ vines init wonderland.lit
$ cd wonderland.lit && vines start
</pre>
  <p>
    That's all there is to it. No database to setup, no web console to configure.
    Just three commands and we're ready to chat.
  </p>
  <p>
    The init command creates two example users in the wonderland.lit domain:
    alice@wonderland.lit and arthur@wonderland.lit. Alice and Arthur are on
    each other's buddy lists (or <em>rosters</em> in XMPP terminology) so they
    can chat together as soon as we login with our favorite chat client.
  </p>
  <p>
    The iChat, <a href="http://adium.im/">Adium</a>, and
    <a href="http://www.pidgin.im/">Pidgin</a> chat clients are nice to get started
    with because they allow us to specify a chat server host name that's different
    from our wonderland.lit domain, which obviously won't route with the fanciful
    .lit extension. So we open our chat client and set the server name to
    localhost and the port to 5222. Then we login with a user name of
    alice@wonderland.lit and password <em>secr3t</em>.
  </p>
  <p>
    We do this once more with arthur@wonderland.lit, his password is also
    <em>secr3t</em>, and we should see each user online and ready to chat.
  </p>

  <h2>A Config File Made for Humans</h2>
  <p>
    Don't worry, we won't be doing any XML situps to configure our server. Here's
    an example Vines server configuration file located at wonderland.lit/conf/config.rb:
  </p>
<pre>
Vines::Config.configure do
  host 'wonderland.lit' do
    storage 'fs' do
      dir 'conf/users'
    end
  end

  client '0.0.0.0', 5222 do
    max_stanza_size 65536
    max_resources_per_account 5
  end

  server '0.0.0.0', 5269 do
    max_stanza_size 131072
    hosts []
  end

  http '0.0.0.0', 5280 do
    max_stanza_size 131072
  end

  component '0.0.0.0', 5347 do
    max_stanza_size 131072
    components 'tea.wonderland.lit'  => 'secr3t',
               'cake.wonderland.lit' => 'passw0rd'
  end
end
</pre>
  <p>
    Hopefully, this is mostly self-explanatory, but let's go through the
    highlights. For full documentation, read the comments in the conf/config.rb
    file.
  </p>

  <h2>Virtual Hosts</h2>
  <p>
    One chat server can host user names at many domains: wonderland.lit,
    verona.lit, example.com, etc. Each of these virtual hosts is configured in
    the config.rb file. Each virtual host can use its own storage database or
    they can share a database.
  </p>
  <p>
    In our example, we've configured the chat server to host the fictitious
    wonderland.lit domain and store user information in the file system under
    the conf/users directory. This means we can chat with any user name in the
    wonderland.lit domain: alice@wonderland.lit, cat@wonderland.lit,
    hatter@wonderland.lit, etc.
  </p>

  <h2>Pluggable Storage</h2>
  <p>
    Vines can store user data in several databases out of the box:
    <a href="http://couchdb.apache.org/">Apache CouchDB</a>,
    <a href="http://redis.io/">Redis</a>, any SQL database, or simply in the
    local file system. It's easy to plug in custom databases through a simple
    storage API. Each of these connectors is documented in the default
    conf/config.rb file.
  </p>
  <p>
    Our example server is using the local file system storage database which
    stores data in one file per user under the conf/users directory. A user file
    is a simple YAML document describing the user and their roster. Let's look
    at the conf/users/alice@wonderland.lit.user file.
  </p>
<pre>
name: Alice 
password: $2a$10$kDyV4w7tKIEuM5Ii7qFQiuGLbIyH3kXW . . .
roster: 
  cat@wonderland.lit: 
    name: Cheshire Cat
    subscription: both
    ask: 
    groups: 
    - Cats
    - Friends
    - Cat Friends
  hatter@wonderland.lit: 
    subscription: none
    ask: subscribe
</pre>
  <p>
    Alice's password is securely stored as a
    <a href="http://en.wikipedia.org/wiki/Bcrypt">bcrypt</a> hash. She has two
    users on her roster: cat@wonderland.lit and hatter@wonderland.lit. The Mad
    Hatter is on her buddy list, but she doesn't have a presence subscription
    to him yet so she can't see when he goes on and offline.
  </p>
  <p>
    To add a new user, the Red Queen, to our chat server, we just copy this
    file and rename it to red.queen@wonderland.lit.user.
  </p> 
  <p>
  </p> 

  <h2>LDAP</h2>
  <p>
    Storing users in the file system is simple and fast, but maybe we're already
    using an LDAP directory to store passwords. We can add an LDAP
    connector to our chat server so authentication is performed against our
    corporate directory instead of the file system.
  </p> 
<pre>
host 'wonderland.lit' do
  storage 'fs' do
    dir 'conf/users'
   end

   ldap 'ldap.wonderland.lit', 636 do
    dn 'cn=Directory Manager'
    password 'secr3t'
    basedn 'dc=wonderland,dc=lit'
    object_class 'person'
    user_attr 'uid'
    name_attr 'cn'
    tls true
  end
end
</pre>
  <p>
    In this example we're storing user information, like rosters, in the file
    system, but not their passwords. When a user logs into the chat server their
    password will be authenticated with the LDAP server at ldap.wonderland.lit
    listening on port 636. The user files under conf/users can have their password
    field deleted. It's never used as long as the LDAP connector is in place.
  </p>
  <p>
    The user_attr property must match the user's chat ID (e.g.
    alice@wonderland.lit). We need to set user_attr to the attribute in our LDAP
    directory with this value. The <em>mail</em> attribute is popular because
    the user's email address generally matches their chat ID.
  </p>

  <h2>Client Connections</h2>
  <p>
    This port is listening for typical, client to server, connections from chat
    programs like iChat. Our example is listening on port 5222 on all interfaces
    on our machine.
  </p>
<pre>
  client '0.0.0.0', 5222 do
    max_stanza_size 65536
    max_resources_per_account 5
  end
</pre>
  <p>
    The <em>max_resources_per_account</em> property specifies how many times one
    user can login at the same time. For example, Alice may be logged in to chat
    on her laptop and her mobile phone.
  </p>

  <h2>Server to Server</h2>
  <p>
    One of the best parts of XMPP is server federation. Users at our wonderland.lit
    domain can chat with users at verona.lit through a server to server connection.
  </p> 
<pre>
  server '0.0.0.0', 5269 do
    max_stanza_size 131072
    hosts ['verona.lit']
  end
</pre>
  <p>
    The <em>hosts</em> property is a white list of remote chat servers to which
    we're allowed to connect. The domain must be listed here and its SSL
    certificate must be trusted for the remote connection to succeed.
  </p>

  <h2>BOSH/HTTP</h2>
  <p>
    Web applications can connect to our chat server by tunneling the XMPP
    protocol through HTTP. This connector allows our web apps to chat just like
    normal XMPP clients.
  </p> 
<pre>
  http '0.0.0.0', 5280 do
    max_stanza_size 131072
  end
</pre>

  <h2>Components</h2>
  <p>
    The XMPP component protocol allows us to extend our chat server with trusted
    services, or bots.
  </p> 
<pre>
  component '0.0.0.0', 5347 do
    max_stanza_size 131072
    components 'tea.wonderland.lit'  => 'secr3t',
               'cake.wonderland.lit' => 'passw0rd'
  end
</pre>
  <p>
    Each sub-domain listed in the <em>components</em> attribute is allowed to
    connect to the server if they provide the shared secret configured here.
  </p>

  <h2>License</h2>
  <p>
    Vines is open source software released under the terms of the MIT license. If
    you have an improvement to the code you'd like to share, send us a
    <a href="http://help.github.com/pull-requests/">GitHub pull request</a> with
    the change and unit tests. If you'd rather not share your changes, that's
    OK too!
  </p> 

  <p>Happy chatting!</p>
</div>

  <div id="footer">
    <a id="logo" href="http://www.negativecode.com">negative <span>code</span></a>.
  </div>
